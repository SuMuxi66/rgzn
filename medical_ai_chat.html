<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ»ç–—AIåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .chat-container {
            display: flex;
            height: 600px;
        }

        .sidebar {
            width: 300px;
            background: #f8f9fa;
            padding: 20px;
            border-right: 1px solid #e9ecef;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .voice-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #4facfe;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .api-settings {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .api-settings input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fff;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
            padding: 15px;
            border-radius: 15px;
            line-height: 1.5;
        }

        .user-message {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            background: #f1f3f4;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .input-area {
            padding: 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .input-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .input-controls button {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .voice-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            animation: pulse 1s infinite;
        }

        .voice-call-btn {
            background: linear-gradient(135deg, #2ed573 0%, #1dd1a1 100%);
            color: white;
        }

        .voice-call-btn.calling {
            background: linear-gradient(135deg, #10ac84 0%, #0abde3 100%);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .text-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .file-btn {
            background: linear-gradient(135deg, #a55eea 0%, #8854d0 100%);
            color: white;
        }

        .input-controls button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .message-input {
            width: 100%;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            font-size: 16px;
            resize: none;
            min-height: 60px;
            max-height: 120px;
        }

        .file-upload {
            display: none;
        }

        .status {
            text-align: center;
            padding: 8px 15px;
            font-weight: bold;
            font-size: 14px;
            border-radius: 8px;
            margin: 5px 15px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .status.recording {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .status.calling {
            background: linear-gradient(135deg, #2ed573 0%, #1dd1a1 100%);
            color: white;
            animation: pulse 2s infinite;
        }

        .status.thinking {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .status.error {
            background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%);
            color: white;
        }

        .status.success {
            background: linear-gradient(135deg, #2ed573 0%, #1dd1a1 100%);
            color: white;
        }

        .typing-indicator {
            display: inline-block;
            padding: 10px 15px;
            background: #f1f3f4;
            border-radius: 15px;
            color: #666;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #666;
            border-radius: 50%;
            margin: 0 2px;
            animation: bounce 1.5s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .file-preview {
            margin-top: 10px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 10px;
            font-size: 14px;
        }

        .file-preview .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
        }

        .remove-file {
            color: #ff4757;
            cursor: pointer;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }

            .sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }

            .message {
                max-width: 90%;
            }
        }

        /* ç—…ä¾‹ä¸‹è½½æŒ‰é’®æ ·å¼ - è¡Œå†…æŒ‰é’® */
        .case-download-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            background: linear-gradient(135deg, #00aaff 0%, #0088cc 100%);
            color: white;
            display: none;
        }

        .case-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ åŒ»ç–—AIåŠ©æ‰‹</h1>
            <p>ä¸“ä¸šçš„åŒ»ç–—å’¨è¯¢ï¼Œæ™ºèƒ½çš„å¯¹è¯ä½“éªŒ</p>
        </div>

        <!-- ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div id="networkStatus" style="position: absolute; top: 10px; right: 10px; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; color: white; background-color: #28a745;">
            ğŸŸ¢ åœ¨çº¿
        </div>

        <div class="chat-container">
            <div class="sidebar">
                <div class="settings-section">
                    <h3>ğŸ”Š è¯­éŸ³è®¾ç½®</h3>
                    <div class="voice-toggle">
                        <span>è¯­éŸ³å›ç­”</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="voiceToggle" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <button class="request-mic-btn" id="requestMicBtn" style="width: 100%; padding: 10px; background: #4facfe; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px;">
                        ğŸ¤ è¯·æ±‚éº¦å…‹é£æƒé™
                    </button>
                </div>

                <div class="settings-section">
                    <h3>âš™ï¸ APIé…ç½®</h3>
                    <div class="api-settings">
                        <input type="text" id="apiUrl" placeholder="APIåœ°å€ (å¦‚: http://192.168.1.127/v1)" value="http://192.168.1.127/v1">
                        <input type="text" id="apiKey" placeholder="APIå¯†é’¥" value="app-XMJAHi5lF45JYmAUcLVKeFui">
                        <input type="text" id="userId" placeholder="ç”¨æˆ·ID" value="">
                    </div>
                </div>

                <div class="settings-section">
                    <h3>ğŸ“„ å·²ä¸Šä¼ æ–‡ä»¶</h3>
                    <div id="fileList" class="file-preview">
                        <div style="text-align: center; color: #666; padding: 20px;">
                            æš‚æ— æ–‡ä»¶
                        </div>
                    </div>
                </div>
            </div>

            <div class="chat-main">
                <div class="messages" id="messages">
                    <div class="message ai-message">
                        æ‚¨å¥½ï¼æˆ‘æ˜¯åŒ»ç–—AIåŠ©æ‰‹ï¼Œä¸“æ³¨äºè…¹éƒ¨ç–¼ç—›è¯Šç–—ã€‚è¯·æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘ä¼šä¸ºæ‚¨æä¾›ä¸“ä¸šçš„åŒ»ç–—å»ºè®®ã€‚
                        <br><br>
                        æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š
                        <br>â€¢ æ–‡å­—è¾“å…¥æ‚¨çš„é—®é¢˜
                        <br>â€¢ ç‚¹å‡»éº¦å…‹é£è¿›è¡Œè¯­éŸ³è¾“å…¥
                        <br>â€¢ ä¸Šä¼ ç—…å†æ–‡ä»¶è¿›è¡Œåˆ†æ
                    </div>
                </div>

                <div class="input-area">
<div class="input-controls">
    <button class="voice-btn" id="voiceBtn">ğŸ¤ è¯­éŸ³è¾“å…¥</button>
    <button class="voice-call-btn" id="voiceCallBtn">ğŸ“ è¯­éŸ³é€šè¯</button>
    <button class="text-btn" id="sendBtn">ğŸ“¤ å‘é€</button>
    <button class="file-btn" id="fileBtn">ğŸ“ ä¸Šä¼ æ–‡ä»¶</button>
    <button class="interrupt-btn" id="interruptBtn" style="background: linear-gradient(135deg, #ff4757 0%, #ff3838 100%); color: white; display: inline-block;">â¹ ä¸­æ–­ç”Ÿæˆ</button>
    <button class="case-download-btn" id="caseDownloadBtn" style="display: none; background: linear-gradient(135deg, #00aaff 0%, #0088cc 100%); color: white;">ğŸ“¥ ä¸‹è½½ç—…ä¾‹</button>
    <button class="new-session-btn" id="newSessionBtn">â• æ–°å»ºä¼šè¯</button>
    <button class="history-btn" id="historyBtn" style="background: linear-gradient(135deg, #9c88ff 0%, #8c7ae6 100%); color: white;">ğŸ•’ å†å²ä¼šè¯</button>
    <input type="file" id="fileUpload" class="file-upload" multiple accept=".pdf,.docx,.png,.jpg,.jpeg,.txt">
</div>
                    <textarea class="message-input" id="messageInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..."></textarea>
                </div>
            </div>
        </div>
    </div>


    <div class="status" id="status">å‡†å¤‡å°±ç»ª</div>

    <script>
        class MedicalAIChat {
            constructor() {
                this.apiUrl = 'http://192.168.1.127/v1';
                this.apiKey = 'app-XMJAHi5lF45JYmAUcLVKeFui';
                this.userId = this.getOrCreateUserId();
                this.conversationId = null;
                this.voiceEnabled = this.getCookie('voiceEnabled') !== 'false';
                this.uploadedFiles = [];
                this.isRecording = false;
                this.recognition = null;
                this.isOnline = navigator.onLine;
                this.currentMode = null; // 'voiceInput' æˆ– 'voiceCall'
                this.isInterrupted = false; // AIå“åº”ä¸­æ–­æ ‡å¿—
                this.chatHistory = []; // æœ¬åœ°èŠå¤©å†å²
                
                this.initializeElements();
                this.bindEvents();
                this.loadSettingsFromCookies();
                this.loadChatHistory(); // åŠ è½½æœ¬åœ°èŠå¤©å†å²
                this.syncSettingsToUI();
                this.initializeSpeechRecognition();
                this.initializeSpeechSynthesis();
                this.autoRequestMicrophone();
                this.setupNetworkMonitoring();
            }

            // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·ID
            getOrCreateUserId() {
                let userId = this.getCookie('userId');
                if (!userId) {
                    // ç”ŸæˆåŒ¿åç”¨æˆ·ID
                    userId = 'anonymous_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                    this.setCookie('userId', userId, 30); // 30å¤©æœ‰æ•ˆæœŸ
                }
                return userId;
            }

            // Cookieæ“ä½œæ–¹æ³•
            setCookie(name, value, days) {
                const expires = new Date();
                expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
                document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
            }

            getCookie(name) {
                const nameEQ = name + "=";
                const ca = document.cookie.split(';');
                for(let i = 0; i < ca.length; i++) {
                    let c = ca[i];
                    while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                    if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
                }
                return null;
            }

            // æœ¬åœ°å­˜å‚¨æ“ä½œæ–¹æ³•
            saveToLocalStorage(key, data) {
                try {
                    localStorage.setItem(key, JSON.stringify(data));
                    return true;
                } catch (error) {
                    console.error('æœ¬åœ°å­˜å‚¨ä¿å­˜å¤±è´¥:', error);
                    return false;
                }
            }

            loadFromLocalStorage(key) {
                try {
                    const data = localStorage.getItem(key);
                    return data ? JSON.parse(data) : null;
                } catch (error) {
                    console.error('æœ¬åœ°å­˜å‚¨åŠ è½½å¤±è´¥:', error);
                    return null;
                }
            }

            // åŠ è½½èŠå¤©å†å²
            loadChatHistory() {
                const history = this.loadFromLocalStorage('medicalAI_chatHistory');
                if (history && Array.isArray(history)) {
                    this.chatHistory = history;
                    // æ˜¾ç¤ºå†å²æ¶ˆæ¯
                    this.chatHistory.forEach(msg => {
                        this.addMessage(msg.content, msg.sender, false); // ä¸ä¿å­˜åˆ°å†å²
                    });
                }
            }

            // ä¿å­˜èŠå¤©å†å²
            saveChatHistory() {
                this.saveToLocalStorage('medicalAI_chatHistory', this.chatHistory);
            }

            // æ·»åŠ æ¶ˆæ¯åˆ°å†å²
            addMessageToHistory(content, sender) {
                this.chatHistory.push({
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    content: content,
                    sender: sender
                });
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (this.chatHistory.length > 100) {
                    this.chatHistory = this.chatHistory.slice(-100);
                }
                this.saveChatHistory();
            }

            // ä»CookieåŠ è½½è®¾ç½®
            loadSettingsFromCookies() {
                const savedApiUrl = this.getCookie('apiUrl');
                const savedApiKey = this.getCookie('apiKey');
                
                if (savedApiUrl) {
                    this.apiUrl = savedApiUrl;
                }
                if (savedApiKey) {
                    this.apiKey = savedApiKey;
                }
            }

            // ä¿å­˜è®¾ç½®åˆ°Cookie
            saveSettingsToCookies() {
                this.setCookie('apiUrl', this.apiUrl, 30);
                this.setCookie('apiKey', this.apiKey, 30);
                this.setCookie('userId', this.userId, 30);
                this.setCookie('voiceEnabled', this.voiceEnabled, 30);
            }

            // åŒæ­¥è®¾ç½®åˆ°UI
            syncSettingsToUI() {
                // åŒæ­¥APIè®¾ç½®
                this.apiUrlInput.value = this.apiUrl;
                this.apiKeyInput.value = this.apiKey;
                this.userIdInput.value = this.userId;
                
                // åŒæ­¥è¯­éŸ³è®¾ç½®
                this.voiceToggle.checked = this.voiceEnabled;
                
                this.updateStatus('è®¾ç½®å·²åŠ è½½');
            }

            // è®¾ç½®ç½‘ç»œç›‘æ§
            setupNetworkMonitoring() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateStatus('ç½‘ç»œå·²è¿æ¥');
                    this.sendBtn.disabled = false;
                    // æ›´æ–°ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨
                    const networkStatus = document.getElementById('networkStatus');
                    if (networkStatus) {
                        networkStatus.innerHTML = 'ğŸŸ¢ åœ¨çº¿';
                        networkStatus.style.backgroundColor = '#28a745';
                    }
                    // ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨é‡è¯•é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯
                    this.processRetryQueue();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateStatus('ç½‘ç»œå·²æ–­å¼€ï¼ŒåŠŸèƒ½å—é™');
                    this.sendBtn.disabled = true;
                    // æ›´æ–°ç½‘ç»œçŠ¶æ€æŒ‡ç¤ºå™¨
                    const networkStatus = document.getElementById('networkStatus');
                    if (networkStatus) {
                        networkStatus.innerHTML = 'ğŸ”´ ç¦»çº¿';
                        networkStatus.style.backgroundColor = '#dc3545';
                    }
                });
            }

            // å¤„ç†é‡è¯•é˜Ÿåˆ—
            async processRetryQueue() {
                // å¦‚æœæœ‰éœ€è¦é‡è¯•çš„æ¶ˆæ¯ï¼Œå¯ä»¥åœ¨è¿™é‡Œå¤„ç†
                // ç›®å‰æˆ‘ä»¬å¯ä»¥åœ¨çŠ¶æ€æ›´æ–°æ—¶æç¤ºç”¨æˆ·
                if (this.retryQueue && this.retryQueue.length > 0) {
                    this.updateStatus(`ç½‘ç»œæ¢å¤ï¼Œæ­£åœ¨é‡è¯• ${this.retryQueue.length} æ¡æ¶ˆæ¯...`);
                }
            }

        // è‡ªåŠ¨è¯·æ±‚éº¦å…‹é£æƒé™
        async autoRequestMicrophone() {
            try {
                // æ£€æŸ¥cookieä¸­æ˜¯å¦å·²è®°å½•æƒé™çŠ¶æ€
                const micPermission = this.getCookie('micPermission');
                if (micPermission === 'granted') {
                    this.updateStatus('éº¦å…‹é£æƒé™å·²è·å–');
                    setTimeout(() => {
                        this.updateStatus('è¯­éŸ³è¯†åˆ«å·²å°±ç»ªï¼Œç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯´è¯');
                    }, 1000);
                    return;
                }
                    
                // æ£€æŸ¥æ˜¯å¦å·²ç»è·å¾—è¿‡æƒé™
                const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                if (permissionStatus.state === 'granted') {
                    this.setCookie('micPermission', 'granted', 30);
                    this.updateStatus('éº¦å…‹é£æƒé™å·²è·å–');
                    setTimeout(() => {
                        this.updateStatus('è¯­éŸ³è¯†åˆ«å·²å°±ç»ªï¼Œç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯´è¯');
                    }, 1000);
                    return;
                }
                    
                    // å°è¯•é™é»˜è¯·æ±‚æƒé™ï¼ˆéœ€è¦ç”¨æˆ·æ‰‹åŠ¿ï¼‰
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop()); // ç«‹å³é‡Šæ”¾
                    
                    this.setCookie('micPermission', 'granted', 30); // ä¿å­˜åˆ°cookie
                    this.updateStatus('éº¦å…‹é£æƒé™å·²è·å–');
                    setTimeout(() => {
                        this.updateStatus('è¯­éŸ³è¯†åˆ«å·²å°±ç»ªï¼Œç‚¹å‡»éº¦å…‹é£å¼€å§‹è¯´è¯');
                    }, 1000);
                } catch (error) {
                    console.log('è‡ªåŠ¨è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
                    this.saveToLocalStorage('micPermission', 'denied');
                    this.updateStatus('ç‚¹å‡»"è¯·æ±‚éº¦å…‹é£æƒé™"æŒ‰é’®æ‰‹åŠ¨æˆæƒ');
                }
            }

            initializeElements() {
                this.messagesDiv = document.getElementById('messages');
                this.messageInput = document.getElementById('messageInput');
                this.voiceBtn = document.getElementById('voiceBtn');
                this.voiceCallBtn = document.getElementById('voiceCallBtn');
                this.sendBtn = document.getElementById('sendBtn');
                this.fileBtn = document.getElementById('fileBtn');
                this.interruptBtn = document.getElementById('interruptBtn');
                this.fileUpload = document.getElementById('fileUpload');
                this.voiceToggle = document.getElementById('voiceToggle');
                this.statusDiv = document.getElementById('status');
                this.fileList = document.getElementById('fileList');
                this.apiUrlInput = document.getElementById('apiUrl');
                this.apiKeyInput = document.getElementById('apiKey');
                this.userIdInput = document.getElementById('userId');
                this.historyBtn = document.getElementById('historyBtn');
            }

            bindEvents() {
                this.sendBtn.addEventListener('click', () => this.sendMessage());
                this.voiceBtn.addEventListener('click', () => this.toggleVoiceInput());
                this.voiceCallBtn.addEventListener('click', () => this.toggleVoiceCall());
                this.fileBtn.addEventListener('click', () => this.fileUpload.click());
                this.interruptBtn.addEventListener('click', () => this.interruptAIResponse());
                this.fileUpload.addEventListener('change', (e) => this.handleFileUpload(e));
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
                this.voiceToggle.addEventListener('change', (e) => {
                    this.voiceEnabled = e.target.checked;
                    this.setCookie('voiceEnabled', this.voiceEnabled, 30);
                    this.updateStatus(`è¯­éŸ³å›ç­”${this.voiceEnabled ? 'å·²å¼€å¯' : 'å·²å…³é—­'}`);
                });

                // APIé…ç½®æ›´æ–°
                this.apiUrlInput.addEventListener('change', (e) => {
                    this.apiUrl = e.target.value;
                    this.setCookie('apiUrl', this.apiUrl, 30);
                });
                this.apiKeyInput.addEventListener('change', (e) => {
                    this.apiKey = e.target.value;
                    this.setCookie('apiKey', this.apiKey, 30);
                });
                this.userIdInput.addEventListener('change', (e) => {
                    this.userId = e.target.value;
                    this.setCookie('userId', this.userId, 30);
                });

                // éº¦å…‹é£æƒé™æŒ‰é’®
                document.getElementById('requestMicBtn').addEventListener('click', () => {
                    this.requestMicrophonePermission();
                });

                // æ–°å»ºä¼šè¯æŒ‰é’®
                document.getElementById('newSessionBtn').addEventListener('click', () => {
                    this.newSession();
                });
                
                // å†å²ä¼šè¯æŒ‰é’®
                document.getElementById('historyBtn').addEventListener('click', () => {
                    window.open('session_history.html', '_blank');
                });
            }

            // è¯·æ±‚éº¦å…‹é£æƒé™
            async requestMicrophonePermission() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    // åœæ­¢æ‰€æœ‰è½¨é“ä»¥é‡Šæ”¾èµ„æº
                    stream.getTracks().forEach(track => track.stop());
                    this.setCookie('micPermission', 'granted', 30);
                    this.updateStatus('éº¦å…‹é£æƒé™å·²è·å–ï¼');
                    setTimeout(() => {
                        this.updateStatus('ç°åœ¨å¯ä»¥ä½¿ç”¨è¯­éŸ³è¾“å…¥åŠŸèƒ½äº†');
                    }, 2000);
                } catch (error) {
                    this.setCookie('micPermission', 'denied', 30);
                    this.updateStatus('éº¦å…‹é£æƒé™è¢«æ‹’ç»: ' + error.message);
                }
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window) {
                    this.recognition = new webkitSpeechRecognition();
                    this.recognition.continuous = true;  // æŒç»­ç›‘å¬
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'zh-CN';

                    // ç”¨äºæ£€æµ‹åœé¡¿çš„è®¡æ—¶å™¨
                    let silenceTimer = null;
                    const SILENCE_THRESHOLD = 3000; // 3ç§’åœé¡¿é˜ˆå€¼
                    const END_KEYWORDS = ['å‘é€', 'ç»“æŸ', 'å®Œæ¯•', 'å¥½äº†', 'å®Œæˆ']; // ç»“æŸå…³é”®è¯

                    this.recognition.onstart = () => {
                        this.isRecording = true;
                        // æ ¹æ®å½“å‰æ¿€æ´»çš„åŠŸèƒ½æ›´æ–°å¯¹åº”æŒ‰é’®çŠ¶æ€
                        if (this.currentMode === 'voiceCall') {
                            this.voiceCallBtn.classList.add('calling');
                            this.voiceCallBtn.textContent = 'â¹ åœæ­¢é€šè¯';
                            this.updateStatus('è¯­éŸ³é€šè¯å·²å¯åŠ¨ï¼Œè¯·è¯´è¯...');
                        } else {
                            this.voiceBtn.classList.add('recording');
                            this.voiceBtn.textContent = 'â¹ åœæ­¢å½•éŸ³';
                            this.updateStatus('æ­£åœ¨å½•éŸ³...');
                        }
                    };

                    this.recognition.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';

                        // é‡ç½®åœé¡¿è®¡æ—¶å™¨
                        if (silenceTimer) {
                            clearTimeout(silenceTimer);
                        }

                        for (let i = event.resultIndex; i < event.results.length; i++) {
                            const transcript = event.results[i][0].transcript;
                            if (event.results[i].isFinal) {
                                finalTranscript += transcript;
                            } else {
                                interimTranscript += transcript;
                            }
                        }

                        // æ ¹æ®å½“å‰æ¨¡å¼å¤„ç†ç»“æœ
                        if (this.currentMode === 'voiceCall') {
                            // è¯­éŸ³é€šè¯æ¨¡å¼ï¼šè¿ç»­å¯¹è¯ï¼Œåœé¡¿3ç§’åè‡ªåŠ¨æš‚åœå¹¶å‘é€
                            if (finalTranscript || interimTranscript) {
                                // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
                                this.messageInput.value = this.messageInput.value + finalTranscript;
                                
                                // è®¾ç½®åœé¡¿æ£€æµ‹è®¡æ—¶å™¨ï¼ˆ3ç§’ï¼‰
                                silenceTimer = setTimeout(() => {
                                    if (this.isRecording && this.currentMode === 'voiceCall') {
                                        // è‡ªåŠ¨æš‚åœè¯­éŸ³è¯†åˆ«
                                        this.recognition.stop();
                                        this.isRecording = false;
                                        // æ˜¾ç¤ºæš‚åœçŠ¶æ€
                                        this.updateStatus('è¯­éŸ³æš‚åœè¾“å…¥ä¸­-AIç”Ÿæˆä¸æ’­æŠ¥ä¸­');
                                        // å‘é€æ¶ˆæ¯
                                        this.sendMessage();
                                        // æ¸…ç©ºè¾“å…¥æ¡†ï¼Œå‡†å¤‡ä¸‹ä¸€æ®µå¯¹è¯
                                        this.messageInput.value = '';
                                    }
                                }, SILENCE_THRESHOLD);
                            }
                        } else {
                            // æ™®é€šè¯­éŸ³è¾“å…¥æ¨¡å¼
                            // æ£€æŸ¥ç»“æŸå…³é”®è¯
                            const fullText = this.messageInput.value + finalTranscript + interimTranscript;
                            const hasEndKeyword = END_KEYWORDS.some(keyword => 
                                fullText.includes(keyword)
                            );

                            if (hasEndKeyword) {
                                // æ£€æµ‹åˆ°ç»“æŸå…³é”®è¯ï¼Œåœæ­¢å½•éŸ³å¹¶å‘é€
                                this.messageInput.value = fullText;
                                this.stopVoiceInput();
                                this.sendMessage();
                                return;
                            }

                            // æ›´æ–°è¾“å…¥æ¡†å†…å®¹
                            this.messageInput.value = this.messageInput.value + finalTranscript;

                            // è®¾ç½®åœé¡¿æ£€æµ‹è®¡æ—¶å™¨
                            silenceTimer = setTimeout(() => {
                                if (this.isRecording) {
                                    this.updateStatus('æ£€æµ‹åˆ°åœé¡¿ï¼Œæ­£åœ¨å‘é€...');
                                    this.stopVoiceInput();
                                    this.sendMessage();
                                }
                            }, SILENCE_THRESHOLD);
                        }
                    };

                    this.recognition.onerror = (event) => {
                        let errorMsg = 'è¯­éŸ³è¯†åˆ«é”™è¯¯: ' + event.error;
                        console.error('Speech recognition error:', event);
                        
                        // æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
                        switch(event.error) {
                            case 'no-speech':
                                errorMsg = 'æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·ç¡®ä¿éº¦å…‹é£å·²è¿æ¥å¹¶è¯´è¯';
                                break;
                            case 'audio-capture':
                                errorMsg = 'æ— æ³•æ•è·éŸ³é¢‘ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£æƒé™';
                                break;
                            case 'not-allowed':
                                errorMsg = 'éº¦å…‹é£è®¿é—®è¢«æ‹’ç»ï¼Œè¯·å…è®¸éº¦å…‹é£æƒé™';
                                break;
                            case 'network':
                                errorMsg = 'ç½‘ç»œé—®é¢˜å¯¼è‡´è¯­éŸ³è¯†åˆ«æœåŠ¡ä¸å¯ç”¨';
                                break;
                        }
                        
                        this.updateStatus(errorMsg);
                        if (this.currentMode === 'voiceCall') {
                            this.stopVoiceCall();
                        } else {
                            this.stopVoiceInput();
                        }
                        
                        // æ˜¾ç¤ºæ›´è¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ç»™ç”¨æˆ·
                        if(event.error === 'not-allowed') {
                            this.addMessage('è¯·ç‚¹å‡»"è¯·æ±‚éº¦å…‹é£æƒé™"æŒ‰é’®é‡æ–°æˆæƒ', 'ai');
                        }
                    };

                    this.recognition.onend = () => {
                        this.isRecording = false;
                        if (this.currentMode === 'voiceCall') {
                            this.stopVoiceCall();
                        } else {
                            this.stopVoiceInput();
                        }
                    };
                } else {
                    this.voiceBtn.disabled = true;
                    this.voiceCallBtn.disabled = true;
                    this.updateStatus('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«');
                }
            }

            initializeSpeechSynthesis() {
                if ('speechSynthesis' in window) {
                    this.synthesis = window.speechSynthesis;
                } else {
                    this.updateStatus('æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ');
                }
            }

            toggleVoiceInput() {
                // å¦‚æœæ­£åœ¨è¯­éŸ³é€šè¯ï¼Œå…ˆåœæ­¢
                if (this.isRecording && this.voiceCallBtn.classList.contains('calling')) {
                    this.stopVoiceCall();
                }

                if (this.isRecording && this.currentMode === 'voiceInput') {
                    this.stopVoiceInput();
                } else {
                    this.startVoiceInput();
                }
            }

            startVoiceInput() {
                if (this.recognition) {
                    try {
                        // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ˜¯å¦å·²ç»å¯åŠ¨ä¸”å¤„äºç›¸åŒæ¨¡å¼
                        if (this.isRecording && this.currentMode === 'voiceInput') {
                            this.updateStatus('è¯­éŸ³è¯†åˆ«å·²åœ¨è¿è¡Œ');
                            return;
                        }
                        // å¦‚æœæ­£åœ¨å…¶ä»–æ¨¡å¼ä¸‹å½•éŸ³ï¼Œå…ˆåœæ­¢
                        if (this.isRecording) {
                            if (this.currentMode === 'voiceCall') {
                                this.stopVoiceCall();
                            }
                        }
                        this.currentMode = 'voiceInput';
                        // ç¡®ä¿è¯­éŸ³è¯†åˆ«æ²¡æœ‰åœ¨è¿è¡Œ
                        if (this.recognition.state === 'listening' || this.recognition.state === 'started') {
                            this.recognition.stop();
                        }
                        this.recognition.start();
                        // ç¦ç”¨è¯­éŸ³é€šè¯æŒ‰é’®
                        this.voiceCallBtn.disabled = true;
                        this.voiceBtn.disabled = false;
                    } catch (error) {
                        // åªæœ‰åœ¨éç”¨æˆ·ä¸»åŠ¨æ“ä½œæ—¶æ‰æ˜¾ç¤ºé”™è¯¯
                        if (!error.message.includes('recognition has already started')) {
                            this.updateStatus('æ— æ³•å¯åŠ¨å½•éŸ³: ' + error.message);
                        }
                    }
                }
            }

            stopVoiceInput() {
                if (this.recognition && this.isRecording && this.currentMode === 'voiceInput') {
                    this.recognition.stop();
                    this.isRecording = false;
                    this.voiceBtn.classList.remove('recording');
                    this.voiceBtn.textContent = 'ğŸ¤ è¯­éŸ³è¾“å…¥';
                    // å¯ç”¨è¯­éŸ³é€šè¯æŒ‰é’®
                    this.voiceCallBtn.disabled = false;
                    this.updateStatus('å½•éŸ³ç»“æŸ');
                }
            }



            // è¯­éŸ³é€šè¯åŠŸèƒ½
            toggleVoiceCall() {
                // å¦‚æœæ­£åœ¨æ™®é€šè¯­éŸ³è¾“å…¥ï¼Œå…ˆåœæ­¢
                if (this.isRecording && !this.voiceCallBtn.classList.contains('calling')) {
                    this.stopVoiceInput();
                }

                if (this.isRecording && this.currentMode === 'voiceCall') {
                    this.stopVoiceCall();
                } else {
                    this.startVoiceCall();
                }
            }

            startVoiceCall() {
                if (this.recognition) {
                    try {
                        // æ£€æŸ¥è¯­éŸ³è¯†åˆ«æ˜¯å¦å·²ç»å¯åŠ¨ä¸”å¤„äºç›¸åŒæ¨¡å¼
                        if (this.isRecording && this.currentMode === 'voiceCall') {
                            this.updateStatus('è¯­éŸ³é€šè¯å·²åœ¨è¿è¡Œ');
                            return;
                        }
                        // å¦‚æœæ­£åœ¨å…¶ä»–æ¨¡å¼ä¸‹å½•éŸ³ï¼Œå…ˆåœæ­¢
                        if (this.isRecording) {
                            if (this.currentMode === 'voiceInput') {
                                this.stopVoiceInput();
                            }
                        }
                        this.currentMode = 'voiceCall';
                        // ç¡®ä¿è¯­éŸ³è¯†åˆ«æ²¡æœ‰åœ¨è¿è¡Œ
                        if (this.recognition.state === 'listening' || this.recognition.state === 'started') {
                            this.recognition.stop();
                        }
                        this.recognition.start();
                        // ç¦ç”¨è¯­éŸ³è¾“å…¥æŒ‰é’®
                        this.voiceBtn.disabled = true;
                        this.voiceCallBtn.disabled = false;
                        this.voiceCallBtn.classList.add('calling');
                        this.voiceCallBtn.textContent = 'â¹ åœæ­¢é€šè¯';
                        this.updateStatus('è¯­éŸ³é€šè¯å·²å¯åŠ¨ï¼Œè¯·è¯´è¯...');
                    } catch (error) {
                        // åªæœ‰åœ¨éç”¨æˆ·ä¸»åŠ¨æ“ä½œæ—¶æ‰æ˜¾ç¤ºé”™è¯¯
                        if (!error.message.includes('recognition has already started')) {
                            this.updateStatus('æ— æ³•å¯åŠ¨è¯­éŸ³é€šè¯: ' + error.message);
                        }
                    }
                }
            }

            stopVoiceCall() {
                if (this.recognition && this.isRecording && this.currentMode === 'voiceCall') {
                    this.recognition.stop();
                    this.isRecording = false;
                    this.voiceCallBtn.classList.remove('calling');
                    this.voiceCallBtn.textContent = 'ğŸ“ è¯­éŸ³é€šè¯';
                    // å¯ç”¨è¯­éŸ³è¾“å…¥æŒ‰é’®
                    this.voiceBtn.disabled = false;
                    this.updateStatus('è¯­éŸ³é€šè¯å·²ç»“æŸ');
                }
            }

            async handleFileUpload(event) {
                const files = event.target.files;
                if (!files.length) return;

                this.updateStatus('æ­£åœ¨å¤„ç†æ–‡ä»¶...');

                for (let file of files) {
                    try {
                        // æ¨¡æ‹Ÿæ–‡ä»¶å¤„ç†ï¼ˆçº¯ç½‘é¡µç‰ˆæœ¬ä¸å®é™…ä¸Šä¼ ï¼‰
                        const fileId = 'file_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        this.uploadedFiles.push({
                            id: fileId,
                            name: file.name,
                            type: file.type,
                            size: file.size
                        });
                        this.updateStatus(`æ–‡ä»¶ "${file.name}" å·²æ·»åŠ `);
                    } catch (error) {
                        this.updateStatus(`æ–‡ä»¶ "${file.name}" å¤„ç†å¤±è´¥: ${error.message}`);
                    }
                }

                this.updateFileList();
                event.target.value = ''; // é‡ç½®æ–‡ä»¶è¾“å…¥
            }

            updateFileList() {
                if (this.uploadedFiles.length === 0) {
                    this.fileList.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">æš‚æ— æ–‡ä»¶</div>';
                    return;
                }

                let html = '';
                this.uploadedFiles.forEach((file, index) => {
                    html += `
                        <div class="file-item">
                            <span>ğŸ“„ ${file.name}</span>
                            <span class="remove-file" onclick="chat.removeFile(${index})">Ã—</span>
                        </div>
                    `;
                });
                this.fileList.innerHTML = html;
            }

            removeFile(index) {
                this.uploadedFiles.splice(index, 1);
                this.updateFileList();
                this.updateStatus('æ–‡ä»¶å·²ç§»é™¤');
            }

            async sendMessage(message = null, retryCount = 0) {
                const messageToSend = message || this.messageInput.value.trim();
                if (!messageToSend) return;

                // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³æ’­æŠ¥ï¼Œå…ˆåœæ­¢å®ƒ
                if (this.synthesis) {
                    this.synthesis.cancel();
                }

                // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢ï¼ˆå¦‚æœæ˜¯é‡è¯•ï¼Œä¸é‡å¤æ·»åŠ ï¼‰
                if (retryCount === 0) {
                    this.addMessage(messageToSend, 'user');
                    this.addMessageToHistory(messageToSend, 'user');
                    this.messageInput.value = '';
                }

                // æ˜¾ç¤ºAIæ­£åœ¨è¾“å…¥
                let typingIndicator = null;
                if (retryCount === 0) {
                    typingIndicator = this.addTypingIndicator();
                } else {
                    // å¦‚æœæ˜¯é‡è¯•ï¼Œæ‰¾åˆ°ç°æœ‰çš„æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                    const existingIndicators = this.messagesDiv.querySelectorAll('.typing-indicator');
                    if (existingIndicators.length > 0) {
                        typingIndicator = existingIndicators[existingIndicators.length - 1].parentElement;
                    } else {
                        typingIndicator = this.addTypingIndicator();
                    }
                }

                try {
                    // å‡†å¤‡æ–‡ä»¶å‚æ•°
                    let files = null;
                    if (this.uploadedFiles.length > 0) {
                        files = this.uploadedFiles.map(file => ({
                            type: 'document',
                            transfer_method: 'local_file',
                            upload_file_id: file.id
                        }));
                    }

                    // æ„é€ è¯·æ±‚ä½“
                    const requestBody = {
                        inputs: {},
                        query: messageToSend,
                        user: this.userId,
                        response_mode: 'streaming'
                    };

                    if (this.conversationId) {
                        requestBody.conversation_id = this.conversationId;
                    }

                    if (files) {
                        requestBody.files = files;
                    }

                    // å‘é€è¯·æ±‚åˆ°åŒ»ç–—AI API
                    const response = await fetch(`${this.apiUrl}/chat-messages`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }

                    // ç§»é™¤æ­£åœ¨è¾“å…¥æŒ‡ç¤ºå™¨
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    // å¤„ç†æµå¼å“åº”
                    await this.handleStreamingResponse(response);

                    // æ¸…ç©ºå·²ä¸Šä¼ æ–‡ä»¶åˆ—è¡¨
                    this.uploadedFiles = [];
                    this.updateFileList();

                } catch (error) {
                    if (typingIndicator) {
                        typingIndicator.remove();
                    }

                    // ç½‘ç»œé”™è¯¯é‡è¯•æœºåˆ¶
                    if ((error.name === 'TypeError' || error.message.includes('fetch')) && retryCount < 3) {
                        this.updateStatus(`ç½‘ç»œé”™è¯¯ï¼Œ${2 ** retryCount}ç§’åé‡è¯•... (${retryCount + 1}/3)`);
                        setTimeout(() => {
                            this.sendMessage(messageToSend, retryCount + 1);
                        }, 2 ** retryCount * 1000); // æŒ‡æ•°é€€é¿
                        return;
                    }
                    
                    this.addMessage(`æŠ±æ­‰ï¼Œå‘ç”Ÿé”™è¯¯: ${error.message}`, 'ai');
                    this.addMessageToHistory(`æŠ±æ­‰ï¼Œå‘ç”Ÿé”™è¯¯: ${error.message}`, 'ai');
                    this.updateStatus('å‘é€æ¶ˆæ¯å¤±è´¥');
                }
            }

            async handleStreamingResponse(response) {
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let aiMessageDiv = null;
                this.isInterrupted = false; // é‡ç½®ä¸­æ–­æ ‡å¿—

                try {
                    while (true) {
                        // æ£€æŸ¥æ˜¯å¦è¢«ä¸­æ–­
                        if (this.isInterrupted) {
                            // å‘é€ä¸­æ–­ä¿¡å·åˆ°æœåŠ¡å™¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
                            this.updateStatus('å›å¤å·²ä¸­æ–­');
                            if (aiMessageDiv) {
                                aiMessageDiv.innerHTML = this.formatMessage(fullResponse + '\n\n<i>ï¼ˆå›å¤å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼‰</i>');
                                this.addMessageToHistory(fullResponse + '\n\n<i>ï¼ˆå›å¤å·²è¢«ç”¨æˆ·ä¸­æ–­ï¼‰</i>', 'ai');
                            }
                            break;
                        }

                        const { done, value } = await reader.read();
                        if (done) break;

                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');

                        for (let line of lines) {
                            line = line.trim();
                            if (line.startsWith('data: ')) {
                                const dataStr = line.substring(6);
                                try {
                                    const data = JSON.parse(dataStr);
                                    const event = data.event || '';

                                    switch (event) {
                                        case 'message':
                                            const answer = data.answer || '';
                                            if (!aiMessageDiv) {
                                                aiMessageDiv = this.addMessage('', 'ai');
                                            }
                                            fullResponse += answer;
                                            aiMessageDiv.innerHTML = this.formatMessage(fullResponse);
                                            // æ»šåŠ¨åˆ°åº•éƒ¨
                                            this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                                            break;

                                        case 'message_end':
                                            // ä¿å­˜ä¼šè¯ID
                                            if (data.conversation_id) {
                                                this.conversationId = data.conversation_id;
                                            }
                                            // è¯­éŸ³æ’­æŠ¥
                                            if (this.voiceEnabled && fullResponse && !this.isInterrupted) {
                                                this.speak(fullResponse);
                                            }
                                            this.updateStatus('å›ç­”å®Œæˆ');
                                            this.addMessageToHistory(fullResponse, 'ai');
                                            break;

                                        case 'error':
                                            const errorMsg = data.message || 'æœªçŸ¥é”™è¯¯';
                                            this.addMessage(`é”™è¯¯: ${errorMsg}`, 'ai');
                                            this.addMessageToHistory(`é”™è¯¯: ${errorMsg}`, 'ai');
                                            this.updateStatus(`AIé”™è¯¯: ${errorMsg}`);
                                            break;
                                    }
                                } catch (parseError) {
                                    // å¿½ç•¥è§£æé”™è¯¯
                                }
                            }
                        }
                    }
                } catch (error) {
                    console.error('æµå¼å“åº”å¤„ç†é”™è¯¯:', error);
                    if (aiMessageDiv && !this.isInterrupted) {
                        aiMessageDiv.innerHTML = this.formatMessage(fullResponse + '\n\n<i>ï¼ˆè¿æ¥ä¸­æ–­ï¼‰</i>');
                        this.addMessageToHistory(fullResponse + '\n\n<i>ï¼ˆè¿æ¥ä¸­æ–­ï¼‰</i>', 'ai');
                    }
                } finally {
                    reader.releaseLock();
                    this.isInterrupted = false; // é‡ç½®ä¸­æ–­æ ‡å¿—
                }
            }

            addMessage(content, sender, saveToHistory = true) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                messageDiv.innerHTML = this.formatMessage(content);
                this.messagesDiv.appendChild(messageDiv);
                this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                
                // ä¿å­˜åˆ°å†å²è®°å½•
                if (saveToHistory) {
                    this.addMessageToHistory(content, sender);
                }
                
                // å¦‚æœæ˜¯AIæ¶ˆæ¯ï¼Œæ˜¾ç¤ºå³ä¸‹è§’çš„ä¸‹è½½æŒ‰é’®
                if (sender === 'ai') {
                    const caseDownloadBtn = document.getElementById('caseDownloadBtn');
                    caseDownloadBtn.style.display = 'flex';
                    caseDownloadBtn.onclick = () => this.downloadCase(content);
                }
                
                return messageDiv;
            }

            addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message ai-message';
                typingDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span> AIæ­£åœ¨æ€è€ƒ...</div>';
                this.messagesDiv.appendChild(typingDiv);
                this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                return typingDiv;
            }

            downloadCase(content) {
                // åˆ›å»ºæ–‡ä»¶å
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T')[0];
                const filename = `ç—…ä¾‹æŠ¥å‘Š_${timestamp}.md`;
                
                // åˆ›å»ºä¸‹è½½é“¾æ¥
                const blob = new Blob([content], { type: 'text/markdown' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                this.updateStatus(`ç—…ä¾‹å·²ä¿å­˜ä¸º ${filename}`);
            }

            formatMessage(content) {
                // ç®€å•çš„Markdownæ ¼å¼åŒ–
                return content
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/\n/g, '<br>');
            }

            speak(text) {
                if (this.synthesis && this.voiceEnabled) {
                    // åœæ­¢å½“å‰æ­£åœ¨æ’­æ”¾çš„è¯­éŸ³
                    this.synthesis.cancel();
                    
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'zh-CN';
                    utterance.rate = 1.2;  // 1.2å€é€Ÿåº¦
                    utterance.pitch = 1.2; // ç¨å¾®æé«˜éŸ³è°ƒï¼Œæ›´æ¸©æŸ”
                    
                    // å°è¯•é€‰æ‹©å¥³æ€§å£°éŸ³
                    const voices = this.synthesis.getVoices();
                    const femaleVoices = voices.filter(voice => 
                        voice.name.includes('female') || 
                        voice.name.includes('Female') ||
                        voice.name.includes('å¥³') ||
                        voice.name.includes('xiaoyan') || // è®¯é£å°ç‡•
                        voice.name.includes('xiaowen')    // è®¯é£å°æ–‡
                    );
                    
                    if (femaleVoices.length > 0) {
                        utterance.voice = femaleVoices[0];
                    }
                    
                    this.synthesis.speak(utterance);
                    this.updateStatus('æ­£åœ¨è¯­éŸ³æ’­æŠ¥...');
                    // æ˜¾ç¤ºä¸­æ–­æŒ‰é’®
                    this.interruptBtn.style.display = 'inline-block';
                    
                    utterance.onend = () => {
                        this.updateStatus('è¯­éŸ³æ’­æŠ¥å®Œæˆ');
                        // è¯­éŸ³æ’­æŠ¥å®Œæˆåæ»šåŠ¨åˆ°æ¶ˆæ¯åº•éƒ¨
                        this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                    };
                    
                    utterance.onerror = (event) => {
                        // åªæœ‰åœ¨éç”¨æˆ·æ“ä½œä¸­æ–­æ—¶æ‰æ˜¾ç¤ºé”™è¯¯æç¤º
                        if (event.error !== 'interrupted' || !this.isInterrupted) {
                            this.updateStatus('è¯­éŸ³æ’­æŠ¥é”™è¯¯: ' + event.error);
                        } else if (event.error === 'interrupted' && this.isInterrupted) {
                            // ç”¨æˆ·ä¸»åŠ¨ä¸­æ–­ï¼Œä¸æ˜¾ç¤ºé”™è¯¯æç¤º
                            this.updateStatus('è¯­éŸ³æ’­æŠ¥å·²ä¸­æ–­');
                        }
                        this.messagesDiv.scrollTop = this.messagesDiv.scrollHeight;
                    };
                }
            }

            // AIè¾“å‡ºä¸­æ–­åŠŸèƒ½
            interruptAIResponse() {
                this.isInterrupted = true;
                this.updateStatus('æ­£åœ¨ä¸­æ–­AIå›å¤...');
                // ä¿æŒä¸­æ–­æŒ‰é’®æ˜¾ç¤ºï¼ˆæ ¹æ®æœ€æ–°è¦æ±‚ï¼‰
                this.interruptBtn.style.display = 'inline-block';
                // å¦‚æœæœ‰æ­£åœ¨è¿›è¡Œçš„è¯­éŸ³æ’­æŠ¥ï¼Œä¹Ÿåœæ­¢å®ƒ
                if (this.synthesis) {
                    this.synthesis.cancel();
                }
            }

            // é¡µé¢å¸è½½æ—¶éšè—ç—…ä¾‹ä¸‹è½½æŒ‰é’®
            hideCaseDownloadButton() {
                const caseDownloadBtn = document.getElementById('caseDownloadBtn');
                if (caseDownloadBtn) {
                    caseDownloadBtn.style.display = 'none';
                }
            }

            // æ–°å»ºä¼šè¯åŠŸèƒ½
            newSession() {
                // ä¿å­˜å½“å‰ä¼šè¯åˆ°å†å²
                if (this.chatHistory.length > 0) {
                    const currentSession = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        title: `ä¼šè¯ ${JSON.parse(localStorage.getItem('medicalAI_sessionHistory') || '[]').length + 1}`,
                        messages: [...this.chatHistory]
                    };
                    
                    // è·å–ç°æœ‰ä¼šè¯å†å²æˆ–åˆ›å»ºæ–°æ•°ç»„
                    const sessionHistory = JSON.parse(localStorage.getItem('medicalAI_sessionHistory')) || [];
                    sessionHistory.push(currentSession);
                    localStorage.setItem('medicalAI_sessionHistory', JSON.stringify(sessionHistory));
                    
                    // åŒæ—¶ä¿å­˜åˆ°cookie
                    this.setCookie('medicalAI_sessionHistory', JSON.stringify(sessionHistory), 30);
                }

                // é‡ç½®å½“å‰ä¼šè¯
                this.conversationId = null;
                this.chatHistory = [];
                this.messagesDiv.innerHTML = '';
                this.saveChatHistory();

                // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                this.addMessage(`æ‚¨å¥½ï¼æˆ‘æ˜¯åŒ»ç–—AIåŠ©æ‰‹ï¼Œä¸“æ³¨äºè…¹éƒ¨ç–¼ç—›è¯Šç–—ã€‚è¯·æè¿°æ‚¨çš„ç—‡çŠ¶ï¼Œæˆ‘ä¼šä¸ºæ‚¨æä¾›ä¸“ä¸šçš„åŒ»ç–—å»ºè®®ã€‚
                    <br><br>
                    æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¸æˆ‘äº¤æµï¼š
                    <br>â€¢ æ–‡å­—è¾“å…¥æ‚¨çš„é—®é¢˜
                    <br>â€¢ ç‚¹å‡»éº¦å…‹é£è¿›è¡Œè¯­éŸ³è¾“å…¥
                    <br>â€¢ ä¸Šä¼ ç—…å†æ–‡ä»¶è¿›è¡Œåˆ†æ`, 'ai');

                this.updateStatus('å·²æ–°å»ºä¼šè¯ï¼Œè¯·è¾“å…¥æ‚¨çš„é—®é¢˜');
            }

            updateStatus(message) {
                // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
                this.statusDiv.classList.remove('recording', 'calling', 'thinking', 'error', 'success');
                
                // æ ¹æ®æ¶ˆæ¯å†…å®¹åº”ç”¨ç›¸åº”çš„æ ·å¼
                if (message.includes('å½•éŸ³') && message.includes('æ­£åœ¨')) {
                    this.statusDiv.classList.add('recording');
                } else if (message.includes('é€šè¯') && (message.includes('æ­£åœ¨') || message.includes('å¯åŠ¨'))) {
                    this.statusDiv.classList.add('calling');
                } else if (message.includes('æ€è€ƒ') || message.includes('ç”Ÿæˆ') || message.includes('å›ç­”') || message.includes('AIç”Ÿæˆ')) {
                    this.statusDiv.classList.add('thinking');
                } else if (message.includes('é”™è¯¯') || message.includes('å¤±è´¥') || message.includes('æ‹’ç»')) {
                    this.statusDiv.classList.add('error');
                } else if (message.includes('å®Œæˆ') || message.includes('æˆåŠŸ') || message.includes('è·å–')) {
                    this.statusDiv.classList.add('success');
                } else if (message.includes('æ‚¨å¯ä»¥è¾“å…¥')) {
                    this.statusDiv.classList.add('success');
                }
                
                // åŠ¨æ€çŠ¶æ€æ£€æµ‹å’Œç¾åŒ–æç¤º
                let displayMessage = message;
                if (this.messageInput && this.messageInput.value.trim() !== '') {
                    if (!this.isRecording) {
                        displayMessage = 'æ‚¨å¯ä»¥è¾“å…¥äº†';
                    }
                } else if (message.includes('æ€è€ƒ') || message.includes('ç”Ÿæˆ') || message.includes('AIç”Ÿæˆ')) {
                    displayMessage = 'AIç”Ÿæˆå›ç­”ä¸­...';
                } else if (message.includes('è¯­éŸ³æ’­æŠ¥')) {
                    displayMessage = 'è¯­éŸ³æ’­æŠ¥ä¸­...';
                } else if (message.includes('å‡†å¤‡å°±ç»ª')) {
                    displayMessage = 'ç³»ç»Ÿå‡†å¤‡å°±ç»ªï¼Œæ‚¨å¯ä»¥å¼€å§‹å¯¹è¯äº†';
                } else if (message.includes('ä¸­æ–­')) {
                    displayMessage = 'æ­£åœ¨ä¸­æ–­æ“ä½œ...';
                } else if (message.includes('æ–‡ä»¶')) {
                    displayMessage = 'æ–‡ä»¶å¤„ç†ä¸­...';
                }
                
                this.statusDiv.textContent = displayMessage;
                
                // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                this.statusDiv.style.transform = 'scale(1.05)';
                setTimeout(() => {
                    this.statusDiv.style.transform = 'scale(1)';
                }, 200);
            }
        }

        // åˆå§‹åŒ–èŠå¤©åº”ç”¨
        const chat = new MedicalAIChat();

        // ç›‘å¬é¡µé¢å¯è§æ€§å˜åŒ–ï¼Œé€‚å½“æ—¶å€™éšè—æŒ‰é’®
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                chat.hideCaseDownloadButton();
            }
        });

            // å…¨å±€å‡½æ•°ä¾›HTMLè°ƒç”¨
            window.chat = chat;
            
            // å¯¼å‡ºä¼šè¯å†å²ä¾›session_history.htmlä½¿ç”¨
            window.getSessionHistory = function() {
                return JSON.parse(localStorage.getItem('medicalAI_sessionHistory')) || [];
            };
    </script>
</body>
</html>
